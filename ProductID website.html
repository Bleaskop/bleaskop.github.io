<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Prijscalculatie</title>
  <style>
    :root{--bg:#fff;--text:#0b0f19;--accent:#244e91;--accent-2:#002e7a;--border:#e5e7eb;--header:#f3f7fb;--muted:#f5f7fa;--lca:#002e7a}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .left,.right{display:flex;gap:12px;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:var(--bg);padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .hint{font-size:13px;opacity:.8}
    .project-input{border:1px solid var(--border);border-radius:10px;padding:8px 10px;min-width:260px;outline:none}
    .project-input:focus{border-color:var(--accent);background:#fff}
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--header);z-index:1;border-bottom:1px solid var(--border)}
    th,td{padding:12px 14px;text-align:left}
    th{font-size:12px;text-transform:uppercase;letter-spacing:.08em;opacity:.85}
    tbody tr{border-top:1px solid var(--border)}
    tfoot td{border-top:2px solid var(--border);font-weight:800}
    tfoot .label{text-transform:uppercase;letter-spacing:.08em}
    .idx{width:64px;color:#6b7280}
    .meters{width:120px}
    .product{min-width:200px}
    .money,.num{text-align:right;white-space:nowrap}
    input.cell{width:100%;border:1px solid transparent;background:transparent;outline:none;border-radius:8px;padding:6px 8px}
    input.cell:focus{border-color:var(--accent);background:#fff}
    input.cell:invalid{border-color:#ef4444;background:#fef2f2}
    .total-eur{font-size:18px}
    .total-lca{font-size:18px;color:var(--lca)}
    .status{margin:10px 0 0;min-height:18px;font-size:13px;opacity:.85}
    @media (max-width:600px){th,td{padding:10px}.idx{width:48px}.meters{width:96px}.project-input{min-width:0;width:100%}.right{flex-wrap:wrap;gap:8px}}
  </style>

  <!-- XLSX: lokaal eerst, CDN fallback -->
  <script src="libs/xlsx.full.min.js" defer
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'"></script>
</head>
<body>
  <div class="wrap">

    <div class="toolbar">
      <div class="left">
        <label class="hint" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer;user-select:none">
          <input id="montageToggle" type="checkbox" style="width:16px;height:16px" />
          Inclusief montage?
        </label>
      </div>
      <div class="right">
        <input id="projectName" class="project-input" type="text" placeholder="Projectnaam" />
      </div>
    </div>

    <div class="table-wrap">
      <table id="sheet" aria-label="Prijs sheet">
        <thead>
          <tr>
            <th class="idx">#</th>
            <th class="product">Product ID</th>
            <th class="meters">Meters</th>
            <th class="money">Prijs/m</th>
            <th class="money">Totaal</th>
            <th class="money">LCA</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr>
            <td class="idx"></td>
            <td class="label">TOTAAL</td>
            <td></td>
            <td></td>
            <td id="sumTotal" class="money total-eur">€ 0,00</td>
            <td id="sumLca" class="money total-lca">€ 0,00</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div id="status" class="status"></div>

    <div style="display:flex;justify-content:flex-end;margin-top:14px">
      <button id="downloadBtn" class="btn btn-primary" title="Download als Excel" disabled>Download</button>
    </div>
  </div>

  <!-- CSV blijft inline: geen CORS/CSP-issues -->
  <script id="inline-csv" type="text/plain">
ID-CODE;LCA met montage;LCA zonder montage;Prijs/m
SALDSM300X245H665;1,802;1,012;94,64
SALDSM300X295H665;1,802;1,012;97,76
SALDSM400X245H665;1,802;1,012;97,76
SALDSM400X295H665;1,802;1,012;101,92
SALDSM500X245H665;1,867;1,077;105,04
SALDSM500X295H665;1,867;1,077;105,04
... (je bestaande CSV; laat ongewijzigd)
  </script>

  <script>
    // ===== Kleinste eigen CSV-parser (vervangt PapaParse) =====
    function parseCSV_semicolon(text){
      const lines = text.split(/\r?\n/).filter(l => l.trim().length);
      if (!lines.length) return {header:[], rows:[]};
      const header = lines[0].split(';').map(h => h.trim());
      const rows = lines.slice(1).map(line => {
        const parts = line.split(';');
        const obj = {};
        header.forEach((h, i) => obj[h] = (parts[i] ?? '').trim());
        return obj;
      });
      return { header, rows };
    }

    // ===== Helpers =====
    const fmtEUR = new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR' });
    const toNum = (v) => {
      if (typeof v === 'number') return isFinite(v) ? v : 0;
      if (v === null || v === undefined) return 0;
      return Number(String(v).replace(/\./g, '').replace(',', '.')) || 0;
    };
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

    // ===== Dataset =====
    let catalog = {}; const lowerIndex = {};
    function buildCatalogFromCSV() {
      const csvText = (document.getElementById('inline-csv')?.textContent || '').trim();
      if (!csvText) return;
      const parsed = parseCSV_semicolon(csvText);
      parsed.rows.forEach(r => {
        const id = String(r['ID-CODE'] || '').trim();
        const price = toNum(r['Prijs/m']);
        const lcaWith = toNum(r['LCA met montage']);
        const lcaWithout = toNum(r['LCA zonder montage']);
        if (id && isFinite(price)) {
          catalog[id] = { price, lca_with: isFinite(lcaWith) ? lcaWith : null, lca_without: isFinite(lcaWithout) ? lcaWithout : null };
          lowerIndex[id.toLowerCase()] = id;
        }
      });
    }
    function lookup(id){
      if (!id) return undefined;
      const keyLower = String(id).trim().toLowerCase();
      const original = lowerIndex[keyLower];
      if (original && catalog[original]) return catalog[original];
      if (catalog[id]) return catalog[id];
      return undefined;
    }

    // ===== DOM wiring =====
    const tbody = document.getElementById('tbody');
    const status = document.getElementById('status');
    const downloadBtn = document.getElementById('downloadBtn');
    let rows = [];

    function createRow(label){
      const tr = document.createElement('tr');

      const tdIdx = document.createElement('td'); tdIdx.className='idx'; tdIdx.textContent=label;
      const tdProduct = document.createElement('td');
      const inpId = document.createElement('input'); inpId.className='cell'; inpId.type='text'; inpId.placeholder='Voer product ID in';
      inpId.setAttribute('aria-label',`Product ID ${label}`); inpId.setAttribute('aria-describedby','status');
      tdProduct.appendChild(inpId);

      const tdMeters = document.createElement('td');
      const inpMeters = document.createElement('input'); inpMeters.className='cell'; inpMeters.type='text'; inpMeters.inputMode='decimal'; inpMeters.placeholder='0,00';
      inpMeters.setAttribute('aria-label',`Meters ${label}`); inpMeters.setAttribute('aria-describedby','status');
      tdMeters.appendChild(inpMeters);

      const tdPrice = document.createElement('td'); tdPrice.className='money'; tdPrice.dataset.col='price'; tdPrice.textContent='—';
      const tdTotal = document.createElement('td'); tdTotal.className='money'; tdTotal.dataset.col='total'; tdTotal.textContent='—';
      const tdLca   = document.createElement('td'); tdLca.className='money';   tdLca.dataset.col='lca';   tdLca.textContent='—';

      tr.append(tdIdx, tdProduct, tdMeters, tdPrice, tdTotal, tdLca);
      tbody.appendChild(tr);

      function recalc(){
        const productId = inpId.value.trim();
        const meters = toNum(inpMeters.value);
        const found = lookup(productId);

        let price = 0, lcaPerM = 0;
        if (found){
          price = Number(found.price) || 0;
          const montageOn = document.getElementById('montageToggle')?.checked;
          const lcaVal = montageOn ? (found.lca_with ?? 0) : (found.lca_without ?? 0);
          lcaPerM = Number(lcaVal) || 0;
          inpId.setCustomValidity(''); status.textContent='';
        }else if (productId){
          inpId.setCustomValidity('Ongeldig Product ID');
          status.textContent = `Ongeldig Product ID: ${productId}`;
        }else{
          inpId.setCustomValidity('');
        }

        if (inpMeters.value && !isFinite(meters)){
          inpMeters.setCustomValidity('Ongeldig getal');
          status.textContent = 'Voer een geldig getal in voor Meters';
        }else{
          inpMeters.setCustomValidity('');
        }

        const total = price * meters;
        const lcaTotal = lcaPerM * meters;

        tdPrice.textContent = price ? fmtEUR.format(price) : '—';
        tdTotal.textContent = total ? fmtEUR.format(total) : (meters ? fmtEUR.format(0) : '—');
        tdLca.textContent   = lcaTotal ? fmtEUR.format(lcaTotal) : (meters ? fmtEUR.format(0) : '—');

        aggregate(); updateDownloadButton(); maybeAddNextRow(label, productId, meters);
      }

      inpId.addEventListener('input', recalc);
      inpMeters.addEventListener('input', recalc);

      rows.push({ label, el: tr }); return { label, el: tr };
    }

    function aggregate(){
      let sumTotal=0, sumLca=0;
      rows.forEach(({el})=>{
        const t = el.querySelector('[data-col="total"]').textContent;
        const l = el.querySelector('[data-col="lca"]').textContent;
        sumTotal += parseMoney(t); sumLca += parseMoney(l);
      });
      document.getElementById('sumTotal').textContent = fmtEUR.format(sumTotal);
      document.getElementById('sumLca').textContent   = fmtEUR.format(sumLca);
    }
    function parseMoney(s){ if (!s || s==='—') return 0; return toNum(String(s).replace(/[^0-9,.-]/g,'')); }

    function maybeAddNextRow(label, productId, meters){
      const idx = letters.indexOf(label); if (idx === -1) return;
      const isActive = !!productId || !!meters;
      const isLast = idx === rows.length - 1;
      if (isActive && isLast){ const nextLabel = letters[idx+1]; if (nextLabel) createRow(nextLabel); }
    }
    function updateDownloadButton(){
      const hasData = rows.some(({el})=>{
        const [inpId, inpMeters] = el.querySelectorAll('input'); return inpId.value.trim() || toNum(inpMeters.value);
      });
      downloadBtn.disabled = !hasData;
    }
    function seedInitialRows(){ rows=[]; tbody.innerHTML=''; for (let i=0;i<2;i++) createRow(letters[i]); aggregate(); updateDownloadButton(); }

    // ===== Excel Export =====
    function toAoaForExcel(){
      const header = ['#','Product ID','Meters','Prijs/m','Totaal','LCA']; const aoa=[header];
      rows.forEach(({label,el})=>{
        const [inpId, inpMeters] = el.querySelectorAll('input');
        const id = inpId.value.trim(); const metersNum = toNum(inpMeters.value);
        const price = parseMoney(el.querySelector('[data-col="price"]').textContent||'');
        const total = parseMoney(el.querySelector('[data-col="total"]').textContent||'');
        const lca   = parseMoney(el.querySelector('[data-col="lca"]').textContent||'');
        if (id || metersNum) aoa.push([label,id,metersNum,price,total,lca]);
      });
      const totalSum = parseMoney(document.getElementById('sumTotal').textContent);
      const lcaSum   = parseMoney(document.getElementById('sumLca').textContent);
      aoa.push(['','TOTAAL','','', totalSum, lcaSum]); return aoa;
    }
    function sanitizeFilenamePart(s){ const clean=(s||'').toString().trim().replace(/[\\/:*?"<>|]+/g,'').replace(/\s+/g,' '); return clean || 'zonder naam'; }
    function buildFileName(){ const proj=sanitizeFilenamePart(document.getElementById('projectName')?.value||''); const montageOn=document.getElementById('montageToggle')?.checked; const suffix=montageOn?'incl montage':'excl montage'; return `[Isoniq rekenhulp]  ${proj} - ${suffix}.xlsx`; }

    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      const aoa = toAoaForExcel();
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const range = XLSX.utils.decode_range(ws['!ref']);
      for (let R=1; R<=range.e.r; R++){
        [['C',2],['D',3],['E',4],['F',5]].forEach(([col,idx])=>{
          const addr = col + (R+1); const cell = ws[addr];
          if (cell && typeof cell.v === 'number'){ cell.t='n'; cell.z='#,##0.00'; }
        });
      }
      XLSX.utils.book_append_sheet(wb, ws, 'Rekenhulp');
      XLSX.writeFile(wb, buildFileName());
    });

    // ===== Init =====
    function recomputeAll(){
      rows.forEach(({el})=>{ const [_, inpMeters] = el.querySelectorAll('input'); inpMeters.dispatchEvent(new Event('input')); });
      status.textContent = 'Berekeningen bijgewerkt vanwege wijziging in montage-instelling.'; setTimeout(()=>{ status.textContent=''; },2000);
    }
    const montageEl = document.getElementById('montageToggle'); if (montageEl) montageEl.addEventListener('change', recomputeAll);

    (function start(){
      try{
        buildCatalogFromCSV(); seedInitialRows();
      }catch(e){
        status.textContent = 'Fout bij initialiseren: ' + (e && e.message ? e.message : e);
        console.error(e);
      }
    })();
  </script>
</body>
</html>
